<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="assets/css/style.css" />
  <link rel="stylesheet" href="assets/css/branding.css" />
</head>
<body>
<div id="app" class="flex flex-column"></div>
<script src="app.js"></script>
<script>
  const bytesStorageKey   = 'bytes';
  const tokenStorageKey   = 'token';
  const routeIDStorageKey = 'route_id';

  const app = Elm.Main.init({
    node: document.getElementById("app"),
    flags: {
      stored_state: storedBytes(),
      token: storedToken(),
      route_id: storedRouteID()
    }
  });

  /* Generate high entropy random bytes using the Web Crypto API and
  remember them so that they are preserved between redirections. This
  allows to protect for XSS & authorization code attacks */
  app.ports.genRandomBytes.subscribe(n => {
    const buffer = new Uint8Array(n);
    crypto.getRandomValues(buffer);
    const bytes = Array.from(buffer);
    localStorage.setItem(bytesStorageKey, bytes);
    app.ports.randomBytes.send(bytes);
  });
  /* Fetch back generated bytes from the local storage */

  function storedBytes() {
    const bytes = localStorage.getItem(bytesStorageKey);
    return bytes ? bytes.split(",").map(x => parseInt(x,10)) : null;
  }

  app.ports.storeToken.subscribe(token => {
    localStorage.setItem(tokenStorageKey, token);
    console.log("Token stored.");
  });

  app.ports.deleteToken.subscribe(() => {
    localStorage.removeItem(tokenStorageKey);
    console.log("Token deleted.");
  });

  function storedToken() {
    let token = localStorage.getItem(tokenStorageKey);
    console.log(token ? "Token loaded." : "Token not found in storage.");
    return token;
  }

  app.ports.storeRouteID.subscribe(id => {
    localStorage.setItem(routeIDStorageKey, id);
    console.log("Route ID stored.");
  });

  function storedRouteID() {
    let routeID = localStorage.getItem(routeIDStorageKey);
    console.log(routeID ? "Route ID loaded." : "Route ID not found in storage.");
    return routeID;
  }
</script>
</body>
</html>